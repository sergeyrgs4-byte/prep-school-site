<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ù–∞–π–¥–∏ —Ñ–∏–≥—É—Ä—É ‚Äî –ê–∑–±—É–ö–∏–¥</title>
<meta name="description" content="–ú–∏–Ω–∏-–∏–≥—Ä–∞ –¥–ª—è –¥–µ—Ç–µ–π 3‚Äì6 –ª–µ—Ç: –Ω–∞–π–¥–∏ –Ω—É–∂–Ω—É—é —Ñ–∏–≥—É—Ä—É –∏ —Ü–≤–µ—Ç. –ö—Ä—É–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏, –≥–æ–ª–æ—Å–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏, –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –∏ –æ—á–∫–∏.">

<style>
  :root{
    --bg:#0f1221; --panel:#141838; --panel2:#101433;
    --text:#f6f7fb; --muted:#c9cbe0;
    --brand:#6ca8ff; --brand2:#7ae1b8; --ok:#79e69f; --bad:#ff7a7a;
    --ring:rgba(108,168,255,.55); --shadow:0 18px 40px rgba(0,0,0,.35);
    --r:18px; --r2:22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 600px at 70% -10%, #1c2455 0%, transparent 60%),
      var(--bg);
    font: 500 17px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    letter-spacing:.1px;
    touch-action: manipulation;
  }
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px; margin:0 auto; padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 0}
  .logo{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.3px}
  .badge{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;
    background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#0b1220; box-shadow:var(--shadow)}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:10px;
    padding:12px 16px;border-radius:14px;font-weight:800;border:none;cursor:pointer;
    background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#0b1220; box-shadow:var(--shadow);
    transition:transform .06s ease, filter .2s ease, opacity .2s ease;
  }
  .btn:disabled{opacity:.5;pointer-events:none}
  .btn:hover{transform:translateY(-1px);filter:saturate(1.06)}
  .btn-ghost{background:transparent;color:var(--text); border:1px solid rgba(255,255,255,.14)}
  .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .stat{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:999px}
  .led{width:10px;height:10px;border-radius:999px;background:var(--brand2);box-shadow:0 0 12px var(--brand2)}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08); border-radius:var(--r2); padding:18px; box-shadow:var(--shadow)
  }
  .board{margin-top:16px; display:grid; gap:12px; grid-template-columns:repeat(4,1fr)}
  @media (max-width:820px){ .board{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:520px){ .board{grid-template-columns:repeat(2,1fr)} }

  .tile{
    position:relative; border-radius:18px; overflow:hidden; cursor:pointer; user-select:none;
    background:linear-gradient(135deg,rgba(108,168,255,.18),rgba(122,225,184,.14));
    border:1px solid rgba(255,255,255,.10); box-shadow:var(--shadow); transition:transform .06s ease, filter .2s ease, border-color .2s ease;
    outline:none;
  }
  .tile:focus-visible{box-shadow:0 0 0 4px var(--ring)}
  .tile:hover{transform:translateY(-2px);filter:saturate(1.06)}
  .tile::before{content:"";display:block;padding-top:100%} /* 1:1 */
  .tile > .inner{position:absolute;inset:0;display:grid;place-items:center}
  .label{position:absolute;bottom:8px;left:8px;right:8px;
    text-align:center;font-weight:900;font-size:14px;color:#0b1220; background:rgba(255,255,255,.9);
    border-radius:999px;padding:6px 10px}

  .goal{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  h1{font-size:clamp(22px,3.4vw,30px);margin:0 0 6px}
  .muted{color:var(--muted)}

  /* progress */
  .progress{height:12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .3s ease}
  .streak{font-weight:900;color:#79e69f}

  /* toast */
  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
    background:rgba(16,20,51,.92); border:1px solid rgba(255,255,255,.12); color:var(--text);
    padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); opacity:0; transition:all .25s ease; z-index:20}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  /* confetti canvas */
  #fx{position:fixed;inset:0;pointer-events:none;z-index:15}

  .controls{display:flex; gap:8px; flex-wrap:wrap}
  .sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
</style>
</head>
<body>
  <canvas id="fx"></canvas>
  <div class="wrap">
    <header>
      <a class="logo" href="/"><span class="badge">A</span><span>–ê–∑–±—É–ö–∏–¥</span></a>
      <div class="topbar">
        <div class="stat" aria-live="polite"><span class="led"></span> –£—Ä–æ–≤–µ–Ω—å: <b id="lvl">1</b></div>
        <div class="stat">–û—á–∫–∏: <b id="score">0</b></div>
        <div class="stat">–°–µ—Ä–∏—è: <b class="streak" id="streak">0</b></div>
        <button class="btn btn-ghost" id="speakBtn" aria-pressed="false" title="–ì–æ–ª–æ—Å–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏">üé§ –ì–æ–ª–æ—Å</button>
        <button class="btn btn-ghost" id="muteBtn" aria-pressed="false" title="–ó–≤—É–∫">üîä –ó–≤—É–∫</button>
        <button class="btn" id="resetBtn" title="–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ">‚Üª –ó–∞–Ω–æ–≤–æ</button>
      </div>
    </header>

    <main class="card" aria-labelledby="goalTitle">
      <div class="goal">
        <div>
          <h1 id="goalTitle">–ù–∞–π–¥–∏: <span id="goalText">‚Äî</span></h1>
          <div class="muted" id="hint">–ù–∞–∂–º–∏ –Ω–∞ –ø–æ–¥—Ö–æ–¥—è—â—É—é –ø–ª–∏—Ç–∫—É. –ë–æ–ª—å—à–∏–µ –∫–Ω–æ–ø–∫–∏ ‚Äî —É–¥–æ–±–Ω–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ.</div>
        </div>
        <div style="min-width:200px;flex:1">
          <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
          <div class="muted" style="font-size:13px;margin-top:6px">–ü—Ä–æ–π–¥–∏ —Ä–∞—É–Ω–¥–æ–≤: <b id="round">0</b>/10</div>
        </div>
      </div>

      <section class="board" id="board" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ">
        <!-- tiles injected -->
      </section>
    </main>

    <p class="muted" style="text-align:center;margin:14px 0 0">
      –°–æ–≤–µ—Ç—ã —Ä–æ–¥–∏—Ç–µ–ª—é: —Ö–≤–∞–ª–∏—Ç–µ –∑–∞ –∫–∞–∂–¥—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä. –ï—Å–ª–∏ –æ—à–∏–±—Å—è ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –Ω–∞–≤–æ–¥—è—â–∏–π –≤–æ–ø—Ä–æ—Å.
    </p>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

<script>
/* ===================== DATA ===================== */
const COLORS = [
  {name:'–∫—Ä–∞—Å–Ω—ã–π', code:'#ff5463'},
  {name:'–∂—ë–ª—Ç—ã–π',  code:'#ffd166'},
  {name:'–∑–µ–ª—ë–Ω—ã–π', code:'#61e294'},
  {name:'—Å–∏–Ω–∏–π',   code:'#6ca8ff'},
  {name:'—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π', code:'#b18cff'}
];
const SHAPES = [
  {name:'–∫—Ä—É–≥', draw:(ctx)=>{ctx.beginPath();ctx.arc(0,0,36,0,Math.PI*2);ctx.fill();}},
  {name:'–∫–≤–∞–¥—Ä–∞—Ç', draw:(ctx)=>{ctx.beginPath();ctx.rect(-36,-36,72,72);ctx.fill();}},
  {name:'—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫', draw:(ctx)=>{ctx.beginPath();ctx.moveTo(0,-40);ctx.lineTo(40,40);ctx.lineTo(-40,40);ctx.closePath();ctx.fill();}},
  {name:'–∑–≤–µ–∑–¥–∞', draw:(ctx)=>{const spikes=5;const outer=40, inner=18; let rot=Math.PI/2*3, x=0, y=0; ctx.beginPath(); ctx.moveTo(0,-outer); for(let i=0;i<spikes;i++){x=Math.cos(rot)*outer; y=Math.sin(rot)*outer; ctx.lineTo(x,y); rot+=Math.PI/spikes; x=Math.cos(rot)*inner; y=Math.sin(rot)*inner; ctx.lineTo(x,y); rot+=Math.PI/spikes;} ctx.lineTo(0,-outer); ctx.closePath(); ctx.fill();}},
  {name:'—Å–µ—Ä–¥—Ü–µ', draw:(ctx)=>{ctx.beginPath(); ctx.moveTo(0,20); ctx.bezierCurveTo(0,0, -40,0, -40,-18); ctx.bezierCurveTo(-40,-36,-20,-40,0,-22); ctx.bezierCurveTo(20,-40,40,-36,40,-18); ctx.bezierCurveTo(40,0,0,0,0,20); ctx.fill();}}
];

const STORAGE_KEY = 'azbukid_shapes_progress_v1';

/* ===================== STATE ===================== */
let state = {
  level: 1,
  score: 0,
  streak: 0,
  round: 0,
  speak: false,
  muted: false,
  target: null,     // {shape, color}
  tiles: []         // [{shape,color,correct,id}]
};

function loadProgress(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const p = JSON.parse(raw);
      state.level = p.level||1;
      state.score = p.score||0;
    }
  }catch(e){}
}
function saveProgress(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({level:state.level, score:state.score}));
}

/* ===================== AUDIO ===================== */
let audioCtx;
function initAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
}
function beepGood(){
  if(state.muted) return;
  initAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='sine'; o.frequency.setValueAtTime(440, audioCtx.currentTime);
  g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.25);
  o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.26);
}
function beepBad(){
  if(state.muted) return;
  initAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='square'; o.frequency.setValueAtTime(200, audioCtx.currentTime);
  g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.25, audioCtx.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.25);
  o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.26);
}

/* ===================== CONFETTI ===================== */
const fx = document.getElementById('fx');
const fctx = fx.getContext('2d');
let confetti = [];
function onResize(){ fx.width = innerWidth; fx.height = innerHeight; }
addEventListener('resize', onResize); onResize();

function spawnConfetti(x,y){
  const n=120;
  for(let i=0;i<n;i++){
    confetti.push({
      x, y, vx:(Math.random()*2-1)*5, vy:(Math.random()*-2-6),
      g:0.18+Math.random()*0.08,
      life: 60+Math.random()*40,
      color: Math.random()<.5 ? '#6ca8ff' : '#7ae1b8',
      size: 2+Math.random()*4
    });
  }
}
function tickFX(){
  fctx.clearRect(0,0,fx.width,fx.height);
  confetti = confetti.filter(p=>p.life>0);
  for(const p of confetti){
    p.life--;
    p.vy += p.g;
    p.x += p.vx; p.y += p.vy;
    fctx.fillStyle = p.color;
    fctx.fillRect(p.x, p.y, p.size, p.size);
  }
  requestAnimationFrame(tickFX);
}
tickFX();

/* ===================== UI HELPERS ===================== */
const $ = s => document.querySelector(s);
const board = $('#board');
const scoreEl = $('#score');
const streakEl = $('#streak');
const lvlEl = $('#lvl');
const roundEl = $('#round');
const bar = $('#bar');
const goalText = $('#goalText');
const toast = $('#toast');

function showToast(text){
  toast.textContent = text;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'), 1500);
}

/* ===================== LOGIC ===================== */
function randomItem(arr){return arr[Math.floor(Math.random()*arr.length)]}
function makeTarget(){
  const color = randomItem(COLORS);
  const shape = randomItem(SHAPES);
  return {color, shape};
}

function drawShapeOnCanvas(canvas, color, shape){
  const ctx = canvas.getContext('2d');
  const dpr = devicePixelRatio||1;
  const W = canvas.clientWidth, H = canvas.clientHeight;
  canvas.width = W*dpr; canvas.height = H*dpr;
  ctx.setTransform(dpr,0,0,dpr, W/2, H/2);
  ctx.clearRect(-W/2,-H/2,W,H);
  ctx.fillStyle = color.code;
  shape.draw(ctx);
  // subtle glossy overlay
  const grad = ctx.createRadialGradient(-10,-10,5, -10,-10,80);
  grad.addColorStop(0,'rgba(255,255,255,.25)');
  grad.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle = grad;
  ctx.beginPath(); ctx.arc(-10,-10,70,0,Math.PI*2); ctx.fill();
}

function tileTemplate(id, label){
  const div = document.createElement('button');
  div.className='tile'; div.setAttribute('data-id', id);
  div.setAttribute('aria-label', label);
  div.innerHTML = `
    <div class="inner">
      <canvas width="10" height="10" style="width:70%;height:70%"></canvas>
      <div class="label">${label}</div>
    </div>`;
  return div;
}

function speak(text){
  if(!state.speak) return;
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ru-RU'; u.rate = 1.0; u.pitch = 1.0;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

function updateHUD(){
  scoreEl.textContent = state.score;
  streakEl.textContent = state.streak;
  lvlEl.textContent = state.level;
  roundEl.textContent = state.round;
  const pct = Math.min(100, (state.round/10)*100);
  bar.style.width = pct + '%';
}

function generateRound(){
  state.round++;
  if(state.round>10){
    // new level
    state.level++;
    state.round = 1;
    saveProgress();
    showToast(`–£—Ä–æ–≤–µ–Ω—å ${state.level}!`);
  }
  // difficulty scaling
  const tilesCount = Math.min(12, 6 + Math.floor(state.level*1.2));
  const target = makeTarget();
  state.target = target;
  goalText.textContent = `${target.color.name} ${target.shape.name}`;
  speak(`–ù–∞–π–¥–∏ ${target.color.name} ${target.shape.name}`);

  // build tiles: ensure at least one correct
  state.tiles = [];
  const correctIndex = Math.floor(Math.random()*tilesCount);
  for(let i=0;i<tilesCount;i++){
    const t = (i===correctIndex)
      ? target
      : { color: randomItem(COLORS), shape: randomItem(SHAPES) };
    state.tiles.push({ id:i, color:t.color, shape:t.shape, correct:i===correctIndex });
  }

  // render
  board.innerHTML = '';
  state.tiles.forEach(t=>{
    const label = `${t.color.name} ${t.shape.name}`;
    const el = tileTemplate(t.id, label);
    board.appendChild(el);
    const canvas = el.querySelector('canvas');
    // delay small to allow layout
    requestAnimationFrame(()=>drawShapeOnCanvas(canvas, t.color, t.shape));
    el.addEventListener('click', ()=>onPick(t, el));
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); el.click(); } });
  });
}

function onPick(tile, el){
  if(tile.correct){
    // feedback
    el.style.borderColor = 'rgba(121,230,159,.95)';
    el.animate([{transform:'scale(1)'},{transform:'scale(1.06)'}],{duration:120});
    beepGood();
    state.score += 10 + state.streak*2;
    state.streak++;
    showToast(['–û—Ç–ª–∏—á–Ω–æ!','–°—É–ø–µ—Ä!','–¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!'][Math.floor(Math.random()*3)]);
    // confetti at tile center
    const r = el.getBoundingClientRect();
    spawnConfetti(r.left + r.width/2, r.top + r.height/2);
    setTimeout(generateRound, 300);
  }else{
    el.style.borderColor = 'rgba(255,122,122,.95)';
    el.animate([{transform:'translateY(0)'},{transform:'translateY(-2px)'},{transform:'translateY(0)'}],{duration:160});
    beepBad();
    state.streak = 0;
    showToast('–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë!');
  }
  updateHUD();
  saveProgress();
}

/* ===================== CONTROLS ===================== */
$('#resetBtn').addEventListener('click', ()=>{
  state.level=1; state.score=0; state.streak=0; state.round=0;
  saveProgress(); updateHUD(); generateRound(); showToast('–ù–æ–≤–∞—è –∏–≥—Ä–∞');
});
$('#muteBtn').addEventListener('click', (e)=>{
  state.muted = !state.muted;
  e.currentTarget.setAttribute('aria-pressed', String(state.muted));
  e.currentTarget.textContent = state.muted ? 'üîá –ë–µ–∑ –∑–≤—É–∫–∞' : 'üîä –ó–≤—É–∫';
  showToast(state.muted ? '–ó–≤—É–∫ –≤—ã–∫–ª.' : '–ó–≤—É–∫ –≤–∫–ª.');
});
$('#speakBtn').addEventListener('click', (e)=>{
  state.speak = !state.speak;
  e.currentTarget.setAttribute('aria-pressed', String(state.speak));
  e.currentTarget.textContent = state.speak ? 'üó£Ô∏è –ì–æ–ª–æ—Å –≤–∫–ª.' : 'üé§ –ì–æ–ª–æ—Å';
  if(state.speak) speak(`–ù–∞–π–¥–∏ ${state.target?.color.name||''} ${state.target?.shape.name||''}`);
});

/* ===================== INIT ===================== */
loadProgress();
updateHUD();
generateRound();

// wake audio on first touch
addEventListener('pointerdown', ()=>{ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }, {once:true});
</script>
</body>
</html>
